# 公网访问配置指南

## 📌 当前映射关系

- **前端**：`http://10.0.169.144:3003` → `http://39.183.168.206:30003` ✅
- **后端**：`http://10.0.169.144:8000` → `http://39.183.168.206:????`（请确认后端公网端口）
- **MinIO**：`http://10.0.169.144:8999` → `http://39.183.168.206:????`（请确认 MinIO 公网端口）

## ⚙️ 配置步骤

### 1. 前端配置

#### 步骤 1：创建环境变量文件

在 `/data/ht/workspace/Reader_QAQ/web/` 目录下创建 `.env` 文件：

```bash
cd /data/ht/workspace/Reader_QAQ/web
cat > .env << 'EOF'
# 后端 API 公网地址（请根据实际后端公网端口修改）
VITE_API_URL=http://39.183.168.206:30000/api
EOF
```

**⚠️ 重要**：请将 `30000` 改为您实际的后端公网端口！

#### 步骤 2：重新构建前端

```bash
cd /data/ht/workspace/Reader_QAQ/web
npm run build
```

如果使用开发模式：
```bash
npm run dev
```

### 2. 后端配置

#### 步骤 1：后端 CORS 配置（已完成 ✅）
后端 CORS 配置已更新，允许以下来源访问：
- `http://localhost:3003` - 本地开发
- `http://10.0.169.144:3003` - 内网地址
- `http://39.183.168.206:30003` - 公网前端地址
- `*` - 所有来源（临时，生产环境建议移除）

#### 步骤 2：MinIO 公网地址配置 ⚠️

**重要**：MinIO 配置已添加但需要您修改为实际端口！

打开 `/data/ht/workspace/Reader_QAQ/src/config/settings.py`，修改：

```python
MINIO_PUBLIC_ENDPOINT: str = "39.183.168.206:30999"  # ⚠️ 改为实际 MinIO 公网端口
```

**或者**直接执行命令（替换 `30999` 为实际端口）：

```bash
# 示例：如果 MinIO 公网端口是 30999
sed -i 's/MINIO_PUBLIC_ENDPOINT: str = "39.183.168.206:30999"/MINIO_PUBLIC_ENDPOINT: str = "39.183.168.206:30999"/' /data/ht/workspace/Reader_QAQ/src/config/settings.py
```

#### 步骤 3：重启后端服务

```bash
cd /data/ht/workspace/Reader_QAQ/src
python main.py
```

### 3. 验证配置

#### 方法 1：通过浏览器访问

1. 打开浏览器，访问：`http://39.183.168.206:30003`
2. 打开浏览器开发者工具（F12）→ Network 标签
3. 尝试登录或注册
4. 查看请求是否成功发送到后端

#### 方法 2：测试后端 API

```bash
# 测试后端健康检查（替换为实际后端公网端口）
curl http://39.183.168.206:30000/api/health
```

应该返回：
```json
{"status": "ok"}
```

## 🔍 常见问题排查

### 问题 0：头像或文档无法加载

**现象**：上传的知识库头像或文档显示不出来

**原因**：MinIO 公网地址未配置或配置错误

**解决方案**：
1. 确认 MinIO 已映射到公网端口
2. 在 `src/config/settings.py` 中正确配置 `MINIO_PUBLIC_ENDPOINT`
3. 重启后端服务

**验证 MinIO 是否可访问**：
```bash
# 替换为实际 MinIO 公网端口
curl http://39.183.168.206:30999
```

### 问题 1：前端请求失败（CORS 错误）

**现象**：浏览器控制台显示 CORS 错误

**解决方案**：
1. 确认后端已重启
2. 检查 `src/config/settings.py` 中的 `CORS_ORIGINS` 是否包含前端公网地址
3. 如果问题依然存在，临时使用 `"*"` 允许所有来源

### 问题 2：API 请求 404

**现象**：所有 API 请求返回 404

**原因**：前端 `.env` 文件中的 API 地址不正确

**解决方案**：
1. 确认后端公网端口号
2. 更新 `web/.env` 文件中的 `VITE_API_URL`
3. 重新构建前端：`npm run build`

### 问题 3：无法访问公网地址

**可能原因**：
1. 防火墙未开放端口
2. 云服务器安全组未配置
3. 端口映射未生效

**解决方案**：
```bash
# 检查端口是否开放
netstat -tlnp | grep 3003
netstat -tlnp | grep 8000

# 如果使用 firewalld
sudo firewall-cmd --add-port=30003/tcp --permanent
sudo firewall-cmd --add-port=30000/tcp --permanent
sudo firewall-cmd --reload

# 如果使用 ufw
sudo ufw allow 30003/tcp
sudo ufw allow 30000/tcp
```

## 📝 配置文件总结

### 前端 `.env` 文件位置

```
/data/ht/workspace/Reader_QAQ/web/.env
```

内容示例：
```env
VITE_API_URL=http://39.183.168.206:30000/api
```

### 后端 CORS 配置位置

```
/data/ht/workspace/Reader_QAQ/src/config/settings.py
```

已配置为允许公网访问 ✅

## 🚀 快速配置命令

```bash
# 1. 创建前端 .env 文件（请先确认后端公网端口）
cat > /data/ht/workspace/Reader_QAQ/web/.env << 'EOF'
VITE_API_URL=http://39.183.168.206:30000/api
EOF

# 2. 重启后端
cd /data/ht/workspace/Reader_QAQ/src
python main.py

# 3. 重启前端（开发模式）
cd /data/ht/workspace/Reader_QAQ/web
npm run dev

# 或构建生产版本
cd /data/ht/workspace/Reader_QAQ/web
npm run build
```

## 📌 注意事项

1. **后端公网端口**：请确认您的后端服务映射到了哪个公网端口，并相应更新 `.env` 文件

2. **生产环境 CORS**：当前配置包含 `"*"`，这在生产环境不安全。配置完成后，建议从 `CORS_ORIGINS` 中移除 `"*"`，只保留具体的域名

3. **HTTPS**：如果使用 HTTPS，需要：
   - 更新 `.env` 中的 URL 为 `https://`
   - 配置 SSL 证书
   - 更新 CORS 配置

4. **环境变量优先级**：
   - `.env.production` - 生产环境（`npm run build`）
   - `.env.development` - 开发环境（`npm run dev`）
   - `.env` - 默认配置

## 🎯 配置清单

请确认以下映射关系并完成配置：

| 服务 | 内网地址 | 公网端口 | 配置文件 | 配置项 | 状态 |
|------|---------|---------|---------|--------|------|
| 前端 | 10.0.169.144:3003 | 30003 | `web/.env` | `VITE_API_URL` | ⚠️ 待配置 |
| 后端 | 10.0.169.144:8000 | ??? | - | CORS 已配置 | ✅ 已完成 |
| MinIO | 10.0.169.144:8999 | ??? | `src/config/settings.py` | `MINIO_PUBLIC_ENDPOINT` | ⚠️ 待确认 |

## ❓ 下一步

请告诉我：
1. **后端公网端口号**（例如：30000）
2. **MinIO 公网端口号**（例如：30999）

我可以帮您生成完整的配置命令！

示例回答：
- "后端是 30000，MinIO 是 30999"
- "后端是 8000，MinIO 是 8999"

