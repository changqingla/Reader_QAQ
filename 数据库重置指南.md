# æ•°æ®åº“é‡ç½®æŒ‡å—

## ğŸ”„ å…¨æ–°éƒ¨ç½²ï¼ˆæ¨èï¼‰

å¦‚æœæ˜¯å…¨æ–°ç¯å¢ƒï¼Œæˆ–è€…å¯ä»¥æ¸…ç©ºæ•°æ®ï¼Œä½¿ç”¨è¿™ä¸ªæ–¹æ³•æœ€ç®€å•ï¼š

```bash
cd /data/ht/workspace/Reader_QAQ/docker

# åœæ­¢å¹¶åˆ é™¤æ‰€æœ‰å®¹å™¨å’Œæ•°æ®å·
docker-compose down -v

# é‡æ–°å¯åŠ¨ï¼ˆä¼šåˆ›å»ºæ–°çš„æ•°æ®åº“ï¼‰
docker-compose up -d

# ç­‰å¾…æœåŠ¡å¥åº·
docker-compose ps
```

ç„¶åå¯åŠ¨åç«¯ï¼š
```bash
cd ../src
python main.py
```

åç«¯ä¼šè‡ªåŠ¨æ‰§è¡Œ `Base.metadata.create_all()`ï¼Œæ ¹æ®æœ€æ–°çš„æ¨¡å‹åˆ›å»ºæ‰€æœ‰è¡¨ï¼Œ**åŒ…æ‹¬ avatar å­—æ®µ**ï¼

---

## ğŸ“Š å·¥ä½œåŸç†

### 1. Docker Compose
- `docker-compose down -v` ä¼šåˆ é™¤ volumesï¼ˆåŒ…æ‹¬æ•°æ®åº“æ•°æ®ï¼‰
- `docker-compose up -d` ä¼šåˆ›å»ºå…¨æ–°çš„ PostgreSQL

### 2. åç«¯è‡ªåŠ¨å»ºè¡¨
`src/main.py` ä¸­çš„ä»£ç ï¼š
```python
async with engine.begin() as conn:
    await conn.run_sync(Base.metadata.create_all)
```

è¿™ä¼šï¼š
- è¯»å–æ‰€æœ‰ Model ç±»çš„å®šä¹‰
- è‡ªåŠ¨ç”Ÿæˆ CREATE TABLE è¯­å¥
- åˆ›å»ºæ‰€æœ‰è¡¨å’Œå­—æ®µ
- **ä¸ä¼šä¿®æ”¹å·²å­˜åœ¨çš„è¡¨**ï¼ˆè¿™å°±æ˜¯ä¸ºä»€ä¹ˆéœ€è¦é‡ç½®ï¼‰

### 3. åŒ…å«çš„è¡¨
è‡ªåŠ¨åˆ›å»ºï¼š
- `users` (åŒ…æ‹¬ avatar å­—æ®µ)
- `knowledge_bases` (åŒ…æ‹¬æ–°å¢çš„ avatar å­—æ®µ)
- `kb_documents`
- `note_folders`
- `notes`
- `favorites`

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### æ•°æ®ä¼šä¸¢å¤±
`docker-compose down -v` ä¼šåˆ é™¤æ‰€æœ‰æ•°æ®ï¼ŒåŒ…æ‹¬ï¼š
- ç”¨æˆ·è´¦å·
- çŸ¥è¯†åº“
- æ–‡æ¡£
- ç¬”è®°
- æ”¶è—

å¦‚æœæœ‰é‡è¦æ•°æ®ï¼Œè¯·å…ˆå¤‡ä»½ã€‚

### ç”Ÿäº§ç¯å¢ƒ
ç”Ÿäº§ç¯å¢ƒåº”è¯¥ä½¿ç”¨æ•°æ®åº“è¿ç§»å·¥å…·ï¼ˆå¦‚ Alembicï¼‰ï¼š

```bash
# ç”Ÿæˆè¿ç§»è„šæœ¬
cd src
alembic revision --autogenerate -m "add avatar to knowledge_bases"

# æ‰§è¡Œè¿ç§»
alembic upgrade head
```

---

## ğŸš€ å®Œæ•´çš„éƒ¨ç½²æµç¨‹

### æ–°ç¯å¢ƒéƒ¨ç½²ï¼ˆ0 â†’ 1ï¼‰

```bash
# 1. å…‹éš†ä»£ç 
git clone <repo>
cd Reader_QAQ

# 2. å¯åŠ¨ Docker æœåŠ¡
cd docker
docker-compose up -d

# 3. ç­‰å¾…æœåŠ¡å°±ç»ª
docker-compose ps  # ç¡®ä¿éƒ½æ˜¯ healthy

# 4. é…ç½®åç«¯ç¯å¢ƒå˜é‡
cd ../src
cp .env.example .env
# ç¼–è¾‘ .env æ–‡ä»¶...

# 5. å®‰è£… Python ä¾èµ–
python3 -m venv venv
source venv/bin/activate
pip install -r requirements.txt

# 6. å¯åŠ¨åç«¯ï¼ˆä¼šè‡ªåŠ¨å»ºè¡¨ï¼‰
python main.py

# 7. å¯åŠ¨å‰ç«¯ï¼ˆå¦ä¸€ä¸ªç»ˆç«¯ï¼‰
cd ../web
pnpm install
pnpm dev
```

è®¿é—® http://localhost:3003ï¼Œæ•°æ®åº“ä¼šè‡ªåŠ¨åˆ›å»ºåŒ…å«æ‰€æœ‰å­—æ®µçš„è¡¨ï¼

---

## ğŸ”§ å¦‚æœå·²æœ‰æ•°æ®åº“æƒ³ä¿ç•™æ•°æ®

### æ–¹æ¡ˆ1ï¼šä½¿ç”¨ Alembicï¼ˆæ¨èï¼‰

```bash
cd src

# åˆå§‹åŒ– Alembicï¼ˆå¦‚æœè¿˜æ²¡æœ‰ï¼‰
alembic init alembic

# ç¼–è¾‘ alembic.ini å’Œ alembic/env.py é…ç½®æ•°æ®åº“è¿æ¥

# ç”Ÿæˆè¿ç§»ï¼ˆä¼šè‡ªåŠ¨æ£€æµ‹æ¨¡å‹å˜åŒ–ï¼‰
alembic revision --autogenerate -m "add avatar column"

# æ‰§è¡Œè¿ç§»
alembic upgrade head
```

### æ–¹æ¡ˆ2ï¼šæ‰‹åŠ¨ ALTER TABLE

```bash
docker exec -it reader_postgres psql -U reader -d reader_qaq

# æ·»åŠ  avatar åˆ—
ALTER TABLE knowledge_bases ADD COLUMN avatar VARCHAR;

\q
```

### æ–¹æ¡ˆ3ï¼šå¯¼å‡ºæ•°æ® â†’ åˆ é™¤ â†’ é‡å»º â†’ å¯¼å…¥

```bash
# 1. å¯¼å‡ºæ•°æ®
docker exec -it reader_postgres pg_dump -U reader -d reader_qaq > backup.sql

# 2. é‡ç½®æ•°æ®åº“
cd docker
docker-compose down -v
docker-compose up -d

# 3. å¯åŠ¨åç«¯ï¼ˆè‡ªåŠ¨å»ºè¡¨ï¼‰
cd ../src
python main.py

# 4. ä¿®æ”¹å¹¶å¯¼å…¥å¤‡ä»½
# éœ€è¦æ‰‹åŠ¨è°ƒæ•´ backup.sql ä¸­çš„ INSERT è¯­å¥
```

---

## âœ… æ¨èåšæ³•

**å¼€å‘é˜¶æ®µ**: ä½¿ç”¨ `docker-compose down -v` é‡ç½®
**ç”Ÿäº§ç¯å¢ƒ**: ä½¿ç”¨ Alembic åšæ•°æ®åº“è¿ç§»

ç›®å‰æ˜¯å¼€å‘é˜¶æ®µï¼Œç›´æ¥é‡ç½®æœ€å¿«ï¼

