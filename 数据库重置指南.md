# 数据库重置指南

## 🔄 全新部署（推荐）

如果是全新环境，或者可以清空数据，使用这个方法最简单：

```bash
cd /data/ht/workspace/Reader_QAQ/docker

# 停止并删除所有容器和数据卷
docker-compose down -v

# 重新启动（会创建新的数据库）
docker-compose up -d

# 等待服务健康
docker-compose ps
```

然后启动后端：
```bash
cd ../src
python main.py
```

后端会自动执行 `Base.metadata.create_all()`，根据最新的模型创建所有表，**包括 avatar 字段**！

---

## 📊 工作原理

### 1. Docker Compose
- `docker-compose down -v` 会删除 volumes（包括数据库数据）
- `docker-compose up -d` 会创建全新的 PostgreSQL

### 2. 后端自动建表
`src/main.py` 中的代码：
```python
async with engine.begin() as conn:
    await conn.run_sync(Base.metadata.create_all)
```

这会：
- 读取所有 Model 类的定义
- 自动生成 CREATE TABLE 语句
- 创建所有表和字段
- **不会修改已存在的表**（这就是为什么需要重置）

### 3. 包含的表
自动创建：
- `users` (包括 avatar 字段)
- `knowledge_bases` (包括新增的 avatar 字段)
- `kb_documents`
- `note_folders`
- `notes`
- `favorites`

---

## ⚠️ 注意事项

### 数据会丢失
`docker-compose down -v` 会删除所有数据，包括：
- 用户账号
- 知识库
- 文档
- 笔记
- 收藏

如果有重要数据，请先备份。

### 生产环境
生产环境应该使用数据库迁移工具（如 Alembic）：

```bash
# 生成迁移脚本
cd src
alembic revision --autogenerate -m "add avatar to knowledge_bases"

# 执行迁移
alembic upgrade head
```

---

## 🚀 完整的部署流程

### 新环境部署（0 → 1）

```bash
# 1. 克隆代码
git clone <repo>
cd Reader_QAQ

# 2. 启动 Docker 服务
cd docker
docker-compose up -d

# 3. 等待服务就绪
docker-compose ps  # 确保都是 healthy

# 4. 配置后端环境变量
cd ../src
cp .env.example .env
# 编辑 .env 文件...

# 5. 安装 Python 依赖
python3 -m venv venv
source venv/bin/activate
pip install -r requirements.txt

# 6. 启动后端（会自动建表）
python main.py

# 7. 启动前端（另一个终端）
cd ../web
pnpm install
pnpm dev
```

访问 http://localhost:3003，数据库会自动创建包含所有字段的表！

---

## 🔧 如果已有数据库想保留数据

### 方案1：使用 Alembic（推荐）

```bash
cd src

# 初始化 Alembic（如果还没有）
alembic init alembic

# 编辑 alembic.ini 和 alembic/env.py 配置数据库连接

# 生成迁移（会自动检测模型变化）
alembic revision --autogenerate -m "add avatar column"

# 执行迁移
alembic upgrade head
```

### 方案2：手动 ALTER TABLE

```bash
docker exec -it reader_postgres psql -U reader -d reader_qaq

# 添加 avatar 列
ALTER TABLE knowledge_bases ADD COLUMN avatar VARCHAR;

\q
```

### 方案3：导出数据 → 删除 → 重建 → 导入

```bash
# 1. 导出数据
docker exec -it reader_postgres pg_dump -U reader -d reader_qaq > backup.sql

# 2. 重置数据库
cd docker
docker-compose down -v
docker-compose up -d

# 3. 启动后端（自动建表）
cd ../src
python main.py

# 4. 修改并导入备份
# 需要手动调整 backup.sql 中的 INSERT 语句
```

---

## ✅ 推荐做法

**开发阶段**: 使用 `docker-compose down -v` 重置
**生产环境**: 使用 Alembic 做数据库迁移

目前是开发阶段，直接重置最快！

