# 开发环境启动指南

## ✅ CORS 问题已解决

通过配置 Vite 开发服务器代理，前端开发时不再有跨域问题。

## 🎯 工作原理

### 开发环境
```
浏览器访问: http://10.0.169.144:3003
                    ↓
        前端开发服务器 (Vite :3003)
                    ↓
        /api/*  → 代理到 http://localhost:8000
        /minio/* → 代理到 http://localhost:8999
```

### 生产环境
```
浏览器访问: http://39.183.168.206:30003
                    ↓
            Nginx (:3005 映射到 30003)
                    ↓
        /api/*  → 代理到 host:8000
        /minio/* → 代理到 MinIO 容器
        /*      → 前端静态文件 (dist/)
```

## 🚀 启动步骤

### 方式 1：开发环境（推荐用于开发）

#### 步骤 1：启动 Docker 基础服务
```bash
cd /data/ht/workspace/Reader_QAQ/docker
docker-compose up -d reader_postgres reader_redis reader_minio
```

**不要启动 Nginx**，开发时不需要。

#### 步骤 2：启动后端
```bash
cd /data/ht/workspace/Reader_QAQ/src
python main.py
```

后端会在 `http://localhost:8000` 启动。

#### 步骤 3：启动前端开发服务器
```bash
cd /data/ht/workspace/Reader_QAQ/web

# 如果刚修改了 vite.config.ts，需要重启
npm run dev
```

前端会在 `http://10.0.169.144:3003` 启动。

#### 步骤 4：访问
- 本地访问：`http://localhost:3003`
- 内网访问：`http://10.0.169.144:3003`

**所有 API 请求会被 Vite 自动代理到本地后端，无 CORS 问题！** ✅

---

### 方式 2：生产环境（用于部署）

#### 步骤 1：构建前端
```bash
cd /data/ht/workspace/Reader_QAQ/web
npm run build
```

#### 步骤 2：启动所有 Docker 服务（包括 Nginx）
```bash
cd /data/ht/workspace/Reader_QAQ/docker
docker-compose up -d
```

#### 步骤 3：启动后端
```bash
cd /data/ht/workspace/Reader_QAQ/src
python main.py
```

#### 步骤 4：访问
- 公网访问：`http://39.183.168.206:30003`

---

## 📋 配置说明

### Vite 代理配置 (`vite.config.ts`)
```typescript
server: {
  proxy: {
    '/api': {
      target: 'http://localhost:8000',
      changeOrigin: true,
    },
    '/minio': {
      target: 'http://localhost:8999',
      changeOrigin: true,
      rewrite: (path) => path.replace(/^\/minio/, ''),
    },
  },
}
```

### API 客户端 (`web/lib/api.ts`)
```typescript
const API_BASE_URL = '/api';  // 使用相对路径
```

### Docker Compose 端口
```yaml
reader_nginx:
  ports:
    - "3005:80"  # 避免与前端开发服务器 (3003) 冲突
```

映射关系：
- 容器内：80
- 宿主机：3005
- 公网：30003（通过端口映射 3005 → 30003）

---

## 🔍 常见问题

### Q1: 前端请求还是跨域错误？

**原因**：Vite 配置未生效

**解决**：
```bash
# 完全停止前端开发服务器（Ctrl+C）
# 然后重新启动
npm run dev
```

### Q2: API 请求 404

**检查后端是否运行**：
```bash
curl http://localhost:8000/api/health
# 应该返回: {"status":"ok"}
```

**检查 Vite 代理配置**：
打开浏览器开发者工具 → Network，看请求是否正确代理。

### Q3: MinIO 文件无法加载

**开发环境**：确保 MinIO 在运行
```bash
docker ps | grep reader_minio
curl http://localhost:8999/minio/health/live
```

**生产环境**：确保 Nginx 容器在运行
```bash
docker ps | grep reader_nginx
```

### Q4: 如何切换开发/生产环境？

**开发环境**：
```bash
# 只启动基础服务，不启动 Nginx
docker-compose up -d reader_postgres reader_redis reader_minio

# 启动后端
cd src && python main.py

# 启动前端开发服务器
cd web && npm run dev
```

**生产环境**：
```bash
# 构建前端
cd web && npm run build

# 启动所有 Docker 服务
cd docker && docker-compose up -d

# 启动后端
cd src && python main.py
```

---

## 📊 端口占用情况

| 服务 | 开发环境端口 | 生产环境端口 | 公网端口 | 说明 |
|------|------------|------------|---------|------|
| 前端开发 | 3003 | - | - | npm run dev |
| 后端 | 8000 | 8000 | - | python main.py |
| PostgreSQL | 5433 | 5433 | - | Docker |
| Redis | 6380 | 6380 | - | Docker |
| MinIO API | 8999 | 8999 | - | Docker |
| MinIO Console | 9002 | 9002 | - | Docker |
| Nginx | - | 3005 | 30003 | Docker（生产） |

---

## ✅ 验证清单

### 开发环境验证
- [ ] `docker ps` 显示 postgres、redis、minio 运行中
- [ ] `curl http://localhost:8000/api/health` 返回 OK
- [ ] 访问 `http://localhost:3003` 能看到登录页
- [ ] 能够成功登录
- [ ] 浏览器开发者工具 Network 无 CORS 错误

### 生产环境验证
- [ ] `docker ps` 显示所有容器（包括 nginx）运行中
- [ ] `ls web/dist/index.html` 文件存在
- [ ] 访问 `http://39.183.168.206:30003` 能看到登录页
- [ ] 能够成功登录
- [ ] 能够上传文件

---

## 🎯 推荐工作流

日常开发：
1. 启动基础 Docker 服务（只启动一次）
2. 启动后端（每次修改后端代码需重启）
3. 启动前端开发服务器（自动热更新）

部署到生产：
1. 构建前端
2. 启动所有 Docker 服务
3. 启动后端

---

## 🔧 快捷命令

创建别名方便使用：

```bash
# 添加到 ~/.bashrc 或 ~/.zshrc
alias reader-dev-start='cd /data/ht/workspace/Reader_QAQ && docker-compose -f docker/docker-compose.yml up -d reader_postgres reader_redis reader_minio'
alias reader-dev-stop='cd /data/ht/workspace/Reader_QAQ/docker && docker-compose stop'
alias reader-backend='cd /data/ht/workspace/Reader_QAQ/src && python main.py'
alias reader-frontend='cd /data/ht/workspace/Reader_QAQ/web && npm run dev'

# 使用
reader-dev-start     # 启动基础服务
reader-backend      # 启动后端
reader-frontend     # 启动前端
```

---

完成！现在您可以愉快地开发了 🎉


