# 笔记创建功能修复说明

## 问题描述
创建笔记时遇到 422 Unprocessable Entity 错误。

## 问题原因
前后端接口定义不匹配：

### 前端发送的数据
```typescript
{
  title: '新笔记',
  content: '',           // 空字符串
  folder: undefined,     // 可能为 undefined
  tags: []
}
```

### 后端原始定义（有问题）
```python
class CreateNoteRequest(BaseModel):
    title: str
    content: str        # 必填，不允许空字符串
    folder: str         # 必填，不允许 None
    tags: List[str] = []
```

## 修复方案

### 1. 修改 Schema (`src/schemas/schemas.py`)
```python
class CreateNoteRequest(BaseModel):
    """Create note request."""
    title: str
    content: Optional[str] = ""      # ✅ 改为可选，默认空字符串
    folder: Optional[str] = None     # ✅ 改为可选，默认 None
    tags: List[str] = []
```

### 2. 修改 Service 层 (`src/services/note_service.py`)
```python
async def create_note(
    self,
    user_id: str,
    title: str,
    content: Optional[str],          # ✅ 改为可选
    folder: Optional[str],
    tags: List[str]
) -> dict:
    """Create a new note."""
    folder_id = folder if folder else None
    note_content = content if content is not None else ""  # ✅ 确保不为 None
    
    note = await self.note_repo.create(
        user_id, title, note_content, folder_id, tags
    )
    return note.to_dict()
```

## 验证

### 数据库层已就绪
```python
# src/models/note.py
content = Column(Text, nullable=False, default="")  # ✅ 有默认值
```

### Repository 层已就绪
```python
# src/repositories/note_repository.py
async def create(
    self,
    user_id: str,
    title: str,
    content: str,  # ✅ 接收字符串（不会是 None）
    folder_id: Optional[str],
    tags: List[str]
) -> Note:
```

## 测试步骤

1. 重启后端服务
   ```bash
   cd src
   python main.py
   ```

2. 在前端点击"新笔记"按钮

3. 预期结果：
   - ✅ 创建成功，返回 201 Created
   - ✅ 笔记出现在列表中
   - ✅ 标题为"新笔记"
   - ✅ 内容为空
   - ✅ 如果在某个文件夹下创建，则归属于该文件夹
   - ✅ 如果在"全部"下创建，则 folder_id 为 NULL

## 相关文件

- ✅ `src/schemas/schemas.py` - 请求体验证
- ✅ `src/services/note_service.py` - 业务逻辑
- ✅ `src/repositories/note_repository.py` - 数据访问（无需修改）
- ✅ `src/models/note.py` - 数据模型（已有默认值）
- ✅ `web/lib/api.ts` - 前端API（无需修改）
- ✅ `web/pages/Notes.tsx` - 前端页面（无需修改）

## 已修复
所有修改已完成，无 linter 错误，可以正常创建笔记了！


