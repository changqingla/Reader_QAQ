# 开发/生产环境切换说明

## 🎯 MinIO 配置差异

### 开发环境
- 前端直接访问 MinIO 内网地址：`http://10.0.169.144:8999`
- 后端返回完整的 presigned URL（包含签名）
- 不通过代理

### 生产环境
- 前端通过 Nginx 代理访问：`/minio/*`
- 后端返回相对路径
- 统一通过公网端口访问

## 🔄 切换步骤

### 切换到开发环境

**1. 修改后端配置** (`src/config/settings.py`)
```python
MINIO_PUBLIC_ENDPOINT: str = "10.0.169.144:8999"
```

**2. 重启后端**
```bash
cd /data/ht/workspace/Reader_QAQ/src
# 停止当前后端（Ctrl+C）
python main.py
```

**3. 重启前端**
```bash
cd /data/ht/workspace/Reader_QAQ/web
# 停止当前前端（Ctrl+C）
# 清理缓存
rm -rf node_modules/.vite
# 重新启动
npm run dev
```

**4. 只启动基础 Docker 服务**
```bash
cd /data/ht/workspace/Reader_QAQ/docker
docker-compose up -d reader_postgres reader_redis reader_minio
# 不启动 Nginx
```

---

### 切换到生产环境

**1. 修改后端配置** (`src/config/settings.py`)
```python
MINIO_PUBLIC_ENDPOINT: str = "nginx"
```

**2. 构建前端**
```bash
cd /data/ht/workspace/Reader_QAQ/web
npm run build
```

**3. 启动所有 Docker 服务**
```bash
cd /data/ht/workspace/Reader_QAQ/docker
docker-compose up -d
# 包括 Nginx
```

**4. 重启后端**
```bash
cd /data/ht/workspace/Reader_QAQ/src
# 停止当前后端（Ctrl+C）
python main.py
```

**5. 访问**
- 公网：`http://39.183.168.206:30003`

---

## 📋 快速参考

| 配置项 | 开发环境 | 生产环境 |
|--------|---------|---------|
| `MINIO_PUBLIC_ENDPOINT` | `10.0.169.144:8999` | `nginx` |
| 前端访问方式 | 开发服务器 (3003) | Nginx 静态文件 |
| MinIO 访问 | 直接访问内网 | 通过 Nginx 代理 |
| Docker 服务 | 只启动 PG/Redis/MinIO | 启动全部（含 Nginx） |
| 前端启动命令 | `npm run dev` | 不需要（已构建） |

---

## 🔍 验证配置

### 开发环境验证
```bash
# 1. 检查后端配置
grep "MINIO_PUBLIC_ENDPOINT" src/config/settings.py
# 应该显示: MINIO_PUBLIC_ENDPOINT: str = "10.0.169.144:8999"

# 2. 检查 Docker 服务（不应有 Nginx）
docker ps --format "table {{.Names}}\t{{.Status}}"
# 应该只有 reader_postgres, reader_redis, reader_minio

# 3. 测试头像上传
# 上传后检查浏览器 Network，URL 应该是：
# http://10.0.169.144:8999/reader-uploads/kb_avatars/...
```

### 生产环境验证
```bash
# 1. 检查后端配置
grep "MINIO_PUBLIC_ENDPOINT" src/config/settings.py
# 应该显示: MINIO_PUBLIC_ENDPOINT: str = "nginx"

# 2. 检查 Docker 服务（应有 Nginx）
docker ps --format "table {{.Names}}\t{{.Status}}"
# 应该有 reader_nginx

# 3. 检查前端构建
ls -lh web/dist/index.html
# 文件应该存在

# 4. 测试头像上传
# 上传后检查浏览器 Network，URL 应该是：
# /minio/reader-uploads/kb_avatars/...
```

---

## ⚠️ 常见错误

### 错误 1: MinIO 403 Forbidden

**原因**：环境配置不匹配

**解决**：
- 开发环境：确保 `MINIO_PUBLIC_ENDPOINT = "10.0.169.144:8999"`
- 生产环境：确保 `MINIO_PUBLIC_ENDPOINT = "nginx"`
- 记得重启后端！

### 错误 2: 前端请求 CORS 错误

**原因**：Vite 代理未生效或配置错误

**解决**：
```bash
# 清理缓存并重启
cd web
rm -rf node_modules/.vite
npm run dev
```

### 错误 3: Nginx 404

**原因**：前端未构建或 Nginx 未启动

**解决**：
```bash
# 构建前端
cd web
npm run build

# 启动 Nginx
cd docker
docker-compose up -d reader_nginx
```

---

## 💡 提示

**推荐使用环境变量管理配置**

可以创建不同的配置文件：
- `config/settings_dev.py` - 开发环境
- `config/settings_prod.py` - 生产环境

然后通过环境变量切换：
```bash
export ENV=development  # 或 production
```

---

## ✅ 当前配置

执行以下命令查看当前环境：

```bash
# 查看 MinIO 配置
grep "MINIO_PUBLIC_ENDPOINT" src/config/settings.py

# 查看运行的服务
docker ps

# 判断环境
if docker ps | grep -q reader_nginx; then
    echo "当前是生产环境（Nginx 运行中）"
else
    echo "当前是开发环境（Nginx 未运行）"
fi
```

