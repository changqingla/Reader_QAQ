# 首页自动滚动和模式禁用修复

## 修复的问题

### 1. 前端不会自动滚动到最新消息 ⚠️

**问题描述：**
在人机对话时，AI 输出内容时页面不会自动滚动，用户需要手动滚动才能看到最新的 AI 回复。

**解决方案：**
1. 添加 `messagesEndRef` 引用，指向消息列表末尾
2. 使用 `useEffect` 监听 `messages` 和 `isStreaming` 变化
3. 每次消息更新时，自动滚动到底部

```typescript
const messagesEndRef = useRef<HTMLDivElement>(null);

// 自动滚动到最新消息
useEffect(() => {
  if (messagesEndRef.current) {
    messagesEndRef.current.scrollIntoView({ behavior: 'smooth' });
  }
}, [messages, isStreaming]);
```

在消息列表末尾添加滚动锚点：
```tsx
{messages.map((msg, index) => (
  // ... 消息渲染
))}
<div ref={messagesEndRef} />
```

### 2. 深度思考和联网搜索按钮应该置灰 ⚠️

**问题描述：**
用户可以切换深度思考和联网搜索模式，但实际上我们希望：
- 深度思考：默认启用且不可更改
- 联网搜索：暂未开放

**解决方案：**
1. 将 `chatMode` 固定为 `'deep'`
2. 将两个按钮都设置为 `disabled={true}`
3. 添加 tooltip 说明原因

```typescript
// 根据选择确定模式：深度思考固定启用
const chatMode = 'deep';
```

```tsx
<button
  className={`${styles.modeButton} ${deepThinking ? styles.active : ''}`}
  disabled={true}
  title="深度思考默认启用"
>
  <Zap size={18} />
  <span>深度思考</span>
</button>
<button
  className={`${styles.modeButton} ${webSearch ? styles.active : ''}`}
  disabled={true}
  title="联网搜索暂未开放"
>
  <Search size={18} />
  <span>联网搜索</span>
</button>
```

## 修改的文件

### `web/pages/Home.tsx`

#### 1. 引入 useRef
```typescript
import React, { useState, useEffect, useRef } from 'react';
```

#### 2. 添加 messagesEndRef
```typescript
const messagesEndRef = useRef<HTMLDivElement>(null);
```

#### 3. 固定 chatMode 为 'deep'
```typescript
// 根据选择确定模式：深度思考固定启用
const chatMode = 'deep';
```

#### 4. 添加自动滚动 effect
```typescript
// 自动滚动到最新消息
useEffect(() => {
  if (messagesEndRef.current) {
    messagesEndRef.current.scrollIntoView({ behavior: 'smooth' });
  }
}, [messages, isStreaming]);
```

#### 5. 在消息列表末尾添加滚动锚点
```tsx
{messages.map((msg, index) => (
  // ...
))}
<div ref={messagesEndRef} />
```

#### 6. 禁用模式切换按钮（两处）

**欢迎界面：**
```tsx
<div className={styles.modeSwitch}>
  <button
    className={`${styles.modeButton} ${deepThinking ? styles.active : ''}`}
    disabled={true}
    title="深度思考默认启用"
  >
    <Zap size={18} />
    <span>深度思考</span>
  </button>
  <button
    className={`${styles.modeButton} ${webSearch ? styles.active : ''}`}
    disabled={true}
    title="联网搜索暂未开放"
  >
    <Search size={18} />
    <span>联网搜索</span>
  </button>
</div>
```

**对话界面：**（同上）

## 用户体验改进

### 自动滚动
- ✅ 用户发送消息后，页面自动滚动到输入框位置
- ✅ AI 回复时，页面实时跟随内容滚动
- ✅ 使用平滑滚动（`behavior: 'smooth'`），体验更好

### 模式禁用
- ✅ 深度思考按钮显示为激活状态但不可点击，鼠标悬停显示"深度思考默认启用"
- ✅ 联网搜索按钮显示为禁用状态，鼠标悬停显示"联网搜索暂未开放"
- ✅ 避免用户误操作切换模式
- ✅ 清晰传达当前可用功能

## 技术细节

### 自动滚动原理

1. **触发时机：**
   - 新消息添加到 `messages` 数组
   - `isStreaming` 状态改变（开始/结束流式传输）

2. **滚动方式：**
   - `scrollIntoView({ behavior: 'smooth' })` - 平滑滚动
   - 目标元素：消息列表末尾的空 div

3. **性能考虑：**
   - 使用 `useRef` 直接操作 DOM，避免不必要的重渲染
   - `useEffect` 依赖数组精确控制触发时机

### 模式禁用原理

1. **chatMode 固定：**
   ```typescript
   const chatMode = 'deep';
   ```
   - 不再从 `deepThinking` 和 `webSearch` 计算
   - 始终使用深度思考模式调用 RAG 服务

2. **按钮状态：**
   - `disabled={true}` - 按钮禁用
   - CSS 会自动应用 `:disabled` 样式（已在 `Home.module.css` 中定义）
   - `title` 属性提供 tooltip 说明

## 其他页面

其他使用 RAG chat 的页面（`KnowledgeDetail.tsx`, `KnowledgeHubDetail.tsx`, `ChatDetail.tsx`, `Favorites.tsx`）是否需要类似的自动滚动功能？

**建议：** 如果这些页面也有对话功能，建议也添加自动滚动，以保持一致的用户体验。

## 测试验证

### 自动滚动测试
1. ✅ 发送一条消息
2. ✅ 观察页面是否自动滚动到最新消息
3. ✅ AI 流式回复时，页面是否持续跟随滚动

### 模式禁用测试
1. ✅ 查看深度思考按钮是否显示激活状态
2. ✅ 尝试点击深度思考按钮，确认无反应
3. ✅ 鼠标悬停查看 tooltip
4. ✅ 查看联网搜索按钮是否显示禁用状态

修复完成！🎉

