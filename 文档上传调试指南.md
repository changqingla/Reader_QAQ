# 文档上传功能调试指南

## 问题：文档状态一直显示 "uploading"

### 原因分析

后台任务（文档处理流程）可能未正常执行。已修复：
- ✅ 使用 FastAPI 的 `BackgroundTasks` 替代 `asyncio.create_task`
- ✅ 在后台任务中创建新的数据库 session
- ✅ 正确传递 doc_repo 到轮询方法

### 验证步骤

#### 1. 检查后端日志
```bash
cd /data/ht/workspace/Reader_QAQ/src
python main.py

# 上传文档后查看日志输出：
# - "Uploaded file: ..." (MinIO上传成功)
# - "Mineru conversion error: ..." (如果是PDF转换失败)
# - "Document parsing error: ..." (如果解析失败)
# - "Document {id} processing completed with {n} chunks" (成功)
```

#### 2. 检查外部服务可达性
```bash
# 测试 Mineru 服务
curl http://10.0.1.9:7788/tasks

# 测试文档处理服务  
curl http://localhost:7791/api/tasks

# 如果无法访问，需要检查网络或修改 .env 配置
```

#### 3. 查看数据库记录
```bash
docker exec -it reader_postgres psql -U reader -d reader_qaq

# 查看文档状态
SELECT id, name, status, mineru_task_id, parse_task_id, error_message 
FROM kb_documents 
ORDER BY created_at DESC 
LIMIT 5;

# 如果 error_message 有值，说明处理失败
```

#### 4. 手动测试外部服务

**测试 Mineru（PDF转换）:**
```bash
curl -X POST "http://10.0.1.9:7788/process-async/" \
  -H "accept: application/json" \
  -H "Content-Type: multipart/form-data" \
  -F "file=@test.pdf"

# 应该返回：
{
  "code": 0,
  "data": {
    "task_id": "xxx",
    "status": "pending"
  }
}
```

**测试文档处理（分块+向量化）:**
```bash
curl -X POST "http://localhost:7791/api/parse-document" \
  -F "file=@test.md" \
  -F "model_factory=VLLM" \
  -F "model_name=bge-m3" \
  -F "base_url=http://localhost:8002/v1" \
  -F "index_name=test_index" \
  -F "document_id=test_doc_001"

# 应该返回：
{
  "success": true,
  "data": {
    "task_id": "xxx"
  }
}
```

### 常见问题排查

#### Q1: 外部服务地址不对
**检查**: `src/.env` 文件
```bash
MINERU_BASE_URL=http://10.0.1.9:7788
DOC_PROCESS_BASE_URL=http://localhost:7791
```

如果服务在其他地址，需要修改配置。

#### Q2: 网络不通
```bash
# 从后端容器测试连通性
curl -v http://10.0.1.9:7788/tasks
curl -v http://localhost:7791/api/tasks
```

#### Q3: 文件格式不支持
当前只支持 PDF 自动转换，其他格式（MD, TXT）直接使用。

Office 文档（DOCX, XLSX, PPTX）需要 Mineru 支持这些格式。

#### Q4: 后台任务异常退出
查看后端日志中的错误堆栈，通常会显示：
```
logger.error(f"Document processing pipeline failed for {doc_id}: {e}")
```

#### Q5: 临时文件路径问题
后台任务会创建临时文件 `/tmp/{doc_id}.md`

确保：
- /tmp 目录可写
- 有足够的磁盘空间

### 调试模式运行

修改 `src/config/settings.py`:
```python
DEBUG = True
```

重启后端，会看到更详细的日志输出。

### 测试用小文件

先用小的 Markdown 文件测试：
```bash
echo "# 测试文档\n\n这是一个测试内容。" > test.md
```

上传这个文件，应该几秒钟内完成处理。

### 预期的正常流程时间线

- **0秒**: status = "uploading" (上传到MinIO)
- **5-30秒**: status = "processing" (PDF转Markdown，仅PDF需要)
- **10-60秒**: status = "chunking" (分块)
- **20-120秒**: status = "embedding" (向量化)
- **完成**: status = "ready", chunkCount > 0

如果超过5分钟还是 "uploading"，说明后台任务根本没启动。

### 解决方案

如果问题持续，可以：

1. **重启后端服务**
```bash
# Ctrl+C 停止
cd /data/ht/workspace/Reader_QAQ/src
python main.py
```

2. **检查数据库连接**
```bash
docker ps | grep reader_postgres
# 确保 PostgreSQL 正在运行
```

3. **查看完整日志**
在 `src/main.py` 中添加更详细的日志配置

4. **测试异步任务**
在后端日志中应该看到后台任务的执行日志，如果完全没有日志输出，说明 BackgroundTasks 没有执行。

### 如果仍然无法解决

可能需要改用 Celery 等专门的任务队列系统，而不是 FastAPI 的 BackgroundTasks。

