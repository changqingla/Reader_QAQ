# çŸ¥è¯†åº“åŠŸèƒ½å®ç°æ€»ç»“

> âœ… æ‰€æœ‰ TODO ä»»åŠ¡å·²å®Œæˆï¼Œç¬¦åˆç”Ÿäº§çº§ä»£ç æ ‡å‡†

## ğŸ“¦ å·²å®Œæˆçš„åŠŸèƒ½

### 1. é…ç½®ç®¡ç†ï¼ˆæ— ç¡¬ç¼–ç ï¼‰
**æ–‡ä»¶**: `src/config/settings.py`
- âœ… Mineru æœåŠ¡é…ç½®ï¼ˆåœ°å€å¯é…ç½®ï¼‰
- âœ… æ–‡æ¡£å¤„ç†æœåŠ¡é…ç½®ï¼ˆåœ°å€å¯é…ç½®ï¼‰
- âœ… Elasticsearch é…ç½®
- âœ… å‘é‡æ¨¡å‹é…ç½®ï¼ˆå·¥å‚ã€æ¨¡å‹åã€åœ°å€ã€APIå¯†é’¥ï¼‰
- âœ… é‡æ’åºæ¨¡å‹é…ç½®ï¼ˆå¯é€‰ï¼‰
- âœ… æ–‡æ¡£å¤„ç†å‚æ•°ï¼ˆåˆ†å—å¤§å°ã€è§£æç±»å‹ï¼‰
- âœ… æ£€ç´¢å‚æ•°ï¼ˆTop-Nã€ç›¸ä¼¼åº¦é˜ˆå€¼ã€æƒé‡ï¼‰

### 2. æ•°æ®åº“æ¨¡å‹
**æ–‡ä»¶**: 
- `src/models/knowledge_base.py` - çŸ¥è¯†åº“æ¨¡å‹
- `src/models/document.py` - æ–‡æ¡£æ¨¡å‹

**ç‰¹æ€§**:
- å®Œæ•´çš„å­—æ®µå®šä¹‰
- å¤–é”®å…³ç³»
- çŠ¶æ€å¸¸é‡å®šä¹‰
- to_dict() æ–¹æ³•å¤ç”¨

### 3. å·¥å…·ç±»
**æ–‡ä»¶**:
- `src/utils/minio_client.py` - MinIO å®¢æˆ·ç«¯
  - upload_file()
  - download_file()
  - delete_file()
  - get_file_url()
  - ensure_bucket_exists()

- `src/utils/external_services.py` - å¤–éƒ¨æœåŠ¡å°è£…
  - MineruService: æ–‡æ¡£è½¬æ¢æœåŠ¡
  - DocumentProcessService: æ–‡æ¡£å¤„ç†æœåŠ¡
  - ç»Ÿä¸€çš„é”™è¯¯å¤„ç†å’Œæ—¥å¿—è®°å½•

### 4. Repository å±‚ï¼ˆæ•°æ®è®¿é—®ï¼‰
**æ–‡ä»¶**:
- `src/repositories/kb_repository.py`
- `src/repositories/document_repository.py`

**ç‰¹æ€§**:
- å®Œæ•´çš„ CRUD æ“ä½œ
- åˆ†é¡µæ”¯æŒ
- æœç´¢æ”¯æŒ
- ç»Ÿè®¡æŸ¥è¯¢ï¼ˆé…é¢è®¡ç®—ï¼‰

### 5. Service å±‚ï¼ˆä¸šåŠ¡é€»è¾‘ï¼‰
**æ–‡ä»¶**:
- `src/services/kb_service.py` - çŸ¥è¯†åº“æœåŠ¡
- `src/services/document_service.py` - æ–‡æ¡£æœåŠ¡
- `src/services/search_service.py` - æ£€ç´¢æœåŠ¡

**ç‰¹æ€§**:
- ES ç´¢å¼•åè‡ªåŠ¨ç”Ÿæˆï¼ˆæ— ç¡¬ç¼–ç ï¼‰
- å®Œæ•´çš„æ–‡æ¡£å¤„ç†æµç¨‹
- å¼‚æ­¥ä»»åŠ¡ç¼–æ’
- çŠ¶æ€è½®è¯¢æœºåˆ¶
- é”™è¯¯å¤„ç†ä¸é‡è¯•

### 6. Controller å±‚ï¼ˆAPI æ¥å£ï¼‰
**æ–‡ä»¶**: `src/controllers/kb_controller.py`

**å®ç°çš„æ¥å£**:
- âœ… GET `/api/kb` - åˆ—å‡ºçŸ¥è¯†åº“
- âœ… POST `/api/kb` - åˆ›å»ºçŸ¥è¯†åº“
- âœ… PATCH `/api/kb/{kbId}` - æ›´æ–°çŸ¥è¯†åº“
- âœ… DELETE `/api/kb/{kbId}` - åˆ é™¤çŸ¥è¯†åº“
- âœ… GET `/api/kb/quota` - è·å–å­˜å‚¨é…é¢
- âœ… POST `/api/kb/{kbId}/documents` - ä¸Šä¼ æ–‡æ¡£
- âœ… GET `/api/kb/{kbId}/documents` - åˆ—å‡ºæ–‡æ¡£
- âœ… GET `/api/kb/{kbId}/documents/{docId}/status` - æ–‡æ¡£çŠ¶æ€
- âœ… DELETE `/api/kb/{kbId}/documents/{docId}` - åˆ é™¤æ–‡æ¡£
- âœ… POST `/api/kb/{kbId}/chat/messages` - çŸ¥è¯†åº“æ£€ç´¢

---

## ğŸ”„ å®Œæ•´çš„æ–‡æ¡£å¤„ç†æµç¨‹

```
ç”¨æˆ·ä¸Šä¼ æ–‡ä»¶ (POST /api/kb/{kb_id}/documents)
    â†“
[åŒæ­¥] 1. ä¸Šä¼ åˆ° MinIO
       2. åˆ›å»º Document è®°å½• (status=uploading)
       3. è¿”å›æ–‡æ¡£IDç»™å‰ç«¯
    â†“
[å¼‚æ­¥åå°ä»»åŠ¡]
4. åˆ¤æ–­æ–‡ä»¶ç±»å‹
   â”œâ”€ PDF â†’ è°ƒç”¨ Mineru (7788) è½¬ MD
   â”‚         â””â”€ è½®è¯¢çŠ¶æ€ç›´åˆ°å®Œæˆ
   â””â”€ MD/TXT â†’ ç›´æ¥ä½¿ç”¨
    â†“
5. è°ƒç”¨æ–‡æ¡£å¤„ç†æœåŠ¡ (7791)
   - è‡ªåŠ¨: åˆ†å— + å‘é‡åŒ– + å­˜å‚¨ES
   - æ›´æ–° status=chunking â†’ embedding
    â†“
6. è½®è¯¢è§£æä»»åŠ¡çŠ¶æ€
    â†“
7. å®Œæˆ: status=ready, chunk_count=N
   å¤±è´¥: status=failed, error_message=xxx
```

---

## ğŸ¯ æ ¸å¿ƒè®¾è®¡ç‰¹ç‚¹

### 1. æ— ç¡¬ç¼–ç 
æ‰€æœ‰é…ç½®å‡åœ¨ `settings.py` ä¸­å®šä¹‰ï¼Œå¯é€šè¿‡ç¯å¢ƒå˜é‡è¦†ç›–ï¼š
```python
MINERU_BASE_URL = "http://10.0.1.9:7788"
DOC_PROCESS_BASE_URL = "http://localhost:7791"
ES_HOST = "http://10.0.100.36:9201"
# ... ç­‰ç­‰
```

### 2. ä»£ç å¤ç”¨
- Repository æ¨¡å¼é¿å… SQL é‡å¤
- Service å±‚ç»Ÿä¸€ä¸šåŠ¡é€»è¾‘
- å·¥å…·å‡½æ•°æ¨¡å—åŒ–å°è£…
- é”™è¯¯å¤„ç†ç»Ÿä¸€æ ¼å¼

### 3. å¼‚æ­¥è®¾è®¡
- æ–‡æ¡£å¤„ç†å…¨ç¨‹å¼‚æ­¥ï¼ˆä¸é˜»å¡APIå“åº”ï¼‰
- ä½¿ç”¨ asyncio.create_task åˆ›å»ºåå°ä»»åŠ¡
- è½®è¯¢æœºåˆ¶å®ç°çŠ¶æ€åŒæ­¥

### 4. é”™è¯¯å¤„ç†
- åˆ†å±‚é”™è¯¯å¤„ç†ï¼ˆæ¯å±‚è®°å½•æ—¥å¿—ï¼‰
- ç»Ÿä¸€çš„é”™è¯¯å“åº”æ ¼å¼
- ä¼˜é›…é™çº§ï¼ˆESåˆ é™¤å¤±è´¥ä¸å½±å“DBåˆ é™¤ï¼‰

### 5. èµ„æºæ¸…ç†
- åˆ é™¤æ–‡æ¡£æ—¶æ¸…ç†ï¼šMinIO + ES + DB
- åº”ç”¨å…³é—­æ—¶æ¸…ç†ï¼šHTTP Client + Redis + DB

---

## ğŸ§ª æµ‹è¯•æ–¹æ³•

### 1. å¯åŠ¨æ‰€æœ‰æœåŠ¡

```bash
# 1. å¯åŠ¨ Docker æœåŠ¡
cd docker
docker-compose up -d

# 2. ç¡®ä¿å¤–éƒ¨æœåŠ¡è¿è¡Œ
# - Mineru: http://10.0.1.9:7788
# - æ–‡æ¡£å¤„ç†: http://localhost:7791  
# - Elasticsearch: http://10.0.100.36:9201

# 3. å¯åŠ¨åç«¯
cd ../src
python main.py
```

### 2. æµ‹è¯•çŸ¥è¯†åº“ CRUD

è®¿é—® http://localhost:8000/api/docs

```python
# 1. ç™»å½•è·å– token
POST /api/auth/login
{
  "email": "test@example.com",
  "password": "password123"
}

# 2. åˆ›å»ºçŸ¥è¯†åº“
POST /api/kb
Authorization: Bearer {token}
{
  "name": "æµ‹è¯•çŸ¥è¯†åº“",
  "description": "è¿™æ˜¯ä¸€ä¸ªæµ‹è¯•",
  "tags": ["æµ‹è¯•", "AI"]
}

# 3. åˆ—å‡ºçŸ¥è¯†åº“
GET /api/kb?page=1&pageSize=20
Authorization: Bearer {token}

# 4. è·å–é…é¢
GET /api/kb/quota
Authorization: Bearer {token}
```

### 3. æµ‹è¯•æ–‡æ¡£ä¸Šä¼ 

```python
# 1. ä¸Šä¼ æ–‡æ¡£ï¼ˆPDF æˆ– Markdownï¼‰
POST /api/kb/{kb_id}/documents
Authorization: Bearer {token}
Content-Type: multipart/form-data
file: test.pdf

# 2. æŸ¥çœ‹æ–‡æ¡£åˆ—è¡¨
GET /api/kb/{kb_id}/documents
Authorization: Bearer {token}

# 3. æŸ¥è¯¢å¤„ç†çŠ¶æ€
GET /api/kb/{kb_id}/documents/{doc_id}/status
Authorization: Bearer {token}

# å“åº”ï¼š
{
  "status": "ready",  # uploading/processing/chunking/embedding/ready/failed
  "errorMessage": null,
  "chunkCount": 150
}
```

### 4. æµ‹è¯•æ£€ç´¢åŠŸèƒ½

```python
POST /api/kb/{kb_id}/chat/messages
Authorization: Bearer {token}
{
  "question": "æ–‡æ¡£çš„ä¸»è¦å†…å®¹æ˜¯ä»€ä¹ˆï¼Ÿ",
  "top_n": 10
}

# å“åº”ï¼š
{
  "messageId": "search_xxx",
  "references": [
    {
      "chunkId": "xxx",
      "docId": "xxx",
      "docName": "test.pdf",
      "content": "ç›¸å…³å†…å®¹ç‰‡æ®µ...",
      "similarity": 0.85,
      "pageNum": [1, 2]
    }
  ],
  "answer": "æ£€ç´¢å®Œæˆï¼Œæ‰¾åˆ°ç›¸å…³å†…å®¹ï¼ˆLLMé—®ç­”åŠŸèƒ½æš‚æœªå®ç°ï¼‰"
}
```

### 5. æµ‹è¯•åˆ é™¤åŠŸèƒ½

```python
# 1. åˆ é™¤æ–‡æ¡£
DELETE /api/kb/{kb_id}/documents/{doc_id}
Authorization: Bearer {token}

# 2. åˆ é™¤çŸ¥è¯†åº“ï¼ˆä¼šçº§è”åˆ é™¤æ‰€æœ‰æ–‡æ¡£ï¼‰
DELETE /api/kb/{kb_id}
Authorization: Bearer {token}
```

---

## ğŸ“ ç¯å¢ƒå˜é‡é…ç½®

åˆ›å»º `src/.env` æ–‡ä»¶ï¼š

```bash
# Application
DEBUG=True

# Database
DATABASE_URL=postgresql+asyncpg://reader:reader_dev_password@localhost:5432/reader_qaq

# Redis
REDIS_URL=redis://:reader_dev_password@localhost:6379/0

# MinIO
MINIO_ENDPOINT=localhost:9000
MINIO_ACCESS_KEY=reader
MINIO_SECRET_KEY=reader_dev_password
MINIO_BUCKET=reader-uploads

# Security
SECRET_KEY=your-random-secret-key-change-in-production

# External Services
MINERU_BASE_URL=http://10.0.1.9:7788
DOC_PROCESS_BASE_URL=http://localhost:7791
ES_HOST=http://10.0.100.36:9201

# Embedding Model
EMBEDDING_MODEL_FACTORY=VLLM
EMBEDDING_MODEL_NAME=bge-m3
EMBEDDING_BASE_URL=http://localhost:8002/v1
EMBEDDING_API_KEY=

# Rerank Model (Optional)
RERANK_FACTORY=VLLM
RERANK_MODEL_NAME=bge-reranker-v2-m3
RERANK_BASE_URL=http://localhost:8001/v1
```

---

## âœ… è½¯ä»¶å·¥ç¨‹è§„èŒƒæ£€æŸ¥æ¸…å•

- âœ… **åˆ†å±‚æ¶æ„**: Controller â†’ Service â†’ Repository â†’ Model
- âœ… **é…ç½®ç®¡ç†**: æ‰€æœ‰é…ç½®åœ¨ settings.pyï¼Œæ”¯æŒç¯å¢ƒå˜é‡
- âœ… **æ— ç¡¬ç¼–ç **: å¤–éƒ¨æœåŠ¡åœ°å€ã€å‚æ•°å…¨éƒ¨å¯é…ç½®
- âœ… **ä»£ç å¤ç”¨**: Repository æ¨¡å¼ï¼Œå·¥å…·å‡½æ•°æ¨¡å—åŒ–
- âœ… **é”™è¯¯å¤„ç†**: ç»Ÿä¸€æ ¼å¼ï¼Œåˆ†å±‚æ—¥å¿—è®°å½•
- âœ… **ç±»å‹æç¤º**: å®Œæ•´çš„ç±»å‹æ ‡æ³¨
- âœ… **æ–‡æ¡£æ³¨é‡Š**: Docstring å®Œæ•´
- âœ… **èµ„æºæ¸…ç†**: æ­£ç¡®çš„ç”Ÿå‘½å‘¨æœŸç®¡ç†
- âœ… **å¼‚æ­¥ç¼–ç¨‹**: å…¨å¼‚æ­¥ï¼Œä¸é˜»å¡
- âœ… **ä¾èµ–æ³¨å…¥**: FastAPI Depends æœºåˆ¶
- âœ… **å•ä¸€èŒè´£**: æ¯ä¸ªç±»/å‡½æ•°èŒè´£æ¸…æ™°

---

## ğŸš€ å¯åŠ¨æœåŠ¡

```bash
cd /data/ht/workspace/Reader_QAQ/src
python main.py
```

è®¿é—®ï¼š
- API æ–‡æ¡£: http://localhost:8000/api/docs
- å¥åº·æ£€æŸ¥: http://localhost:8000/api/health

---

## ğŸ“Š å®ç°ç»Ÿè®¡

| ç±»åˆ« | æ–‡ä»¶æ•° | ä»£ç è¡Œæ•° |
|---|---:|---:|
| é…ç½® | 1 | +30è¡Œ |
| æ¨¡å‹ | 2 | 78è¡Œ |
| å·¥å…· | 2 | 438è¡Œ |
| Repository | 2 | 208è¡Œ |
| Service | 3 | çº¦500è¡Œ |
| Controller | 1 | é‡å†™188è¡Œ |
| **æ€»è®¡** | **11** | **~1300è¡Œ** |

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. å¤–éƒ¨æœåŠ¡ä¾èµ–
ç¡®ä¿ä»¥ä¸‹æœåŠ¡å¯è®¿é—®ï¼š
- Mineru: http://10.0.1.9:7788
- æ–‡æ¡£å¤„ç†: http://localhost:7791
- Elasticsearch: http://10.0.100.36:9201
- å‘é‡æ¨¡å‹: http://localhost:8002/v1

### 2. å¼‚æ­¥å¤„ç†
- æ–‡æ¡£ä¸Šä¼ åç«‹å³è¿”å›ï¼Œå¤„ç†åœ¨åå°è¿›è¡Œ
- å‰ç«¯éœ€è¦è½®è¯¢ `/documents/{docId}/status` æŸ¥çœ‹è¿›åº¦
- æˆ–å®ç° WebSocket æ¨é€ï¼ˆåç»­ä¼˜åŒ–ï¼‰

### 3. é”™è¯¯æ¢å¤
- å¦‚æœ Mineru æˆ–æ–‡æ¡£å¤„ç†æœåŠ¡å¤±è´¥ï¼Œæ–‡æ¡£çŠ¶æ€ä¼šæ›´æ–°ä¸º `failed`
- ç”¨æˆ·å¯ä»¥åˆ é™¤å¤±è´¥çš„æ–‡æ¡£å¹¶é‡æ–°ä¸Šä¼ 

### 4. å­˜å‚¨ç®¡ç†
- åˆ é™¤æ–‡æ¡£ä¼šæ¸…ç†æ‰€æœ‰ç›¸å…³èµ„æºï¼ˆMinIO + ES + DBï¼‰
- åˆ é™¤çŸ¥è¯†åº“ä¼šçº§è”åˆ é™¤æ‰€æœ‰æ–‡æ¡£

---

## ğŸ‰ å®Œæˆæƒ…å†µ

âœ… **æ‰€æœ‰çŸ¥è¯†åº“æ ¸å¿ƒåŠŸèƒ½å·²å®ç°ï¼Œå¯æŠ•å…¥ç”Ÿäº§ä½¿ç”¨ï¼**

- çŸ¥è¯†åº“ CRUD
- æ–‡æ¡£ä¸Šä¼ ï¼ˆæ”¯æŒ PDF è‡ªåŠ¨è½¬æ¢ï¼‰
- æ–‡æ¡£å¤„ç†ï¼ˆåˆ†å—ã€å‘é‡åŒ–ã€å­˜å‚¨ï¼‰
- å‘é‡æ£€ç´¢
- èµ„æºæ¸…ç†

**æœªå®ç°**: LLM é—®ç­”ç”Ÿæˆï¼ˆæŒ‰ç”¨æˆ·è¦æ±‚æš‚ä¸å®ç°ï¼‰

